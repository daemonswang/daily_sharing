## 兼容性
兼容性（Compatibility） 指的是新旧系统（包括软件或硬件）之间能否正确协作，不需要额外修改或只能少量修改。
简单来说就是维护系统或软件，对外表现的行为在新旧版本之间不发生变化，这种能力对于用户来说非常重要，因为使用的惯性，当旧方法工作的很好的时候，没人愿意莫名其妙的因为引入新版本的依赖而对系统进行适配。

### **接口的兼容**
接口是用户和实现者之间的协议，包含语法和语义两个层面，接口的兼容性需要语法和语义都保持稳定。

- 语法层面：
  - 不能移除老接口
  - 不能改变接口的函数签名（包括增加参数，移除参数，改变参数顺序，改变返回值类型等）
  - 可以增加新的接口

- 语义层面：
  - 接口的对外表现行为（做的事情）应该跟老的实现一致（不能偷偷摸摸加入新的也不能删掉旧的）

接口的兼容，为后文的介绍建立了一个基础。

### ABI的兼容性
共享库的二进制兼容是指：一个可执行文件，运行时会依赖很多动态库，当其中一个动态库有升级的版本时，仅仅通过简单的文件拷贝或者替换，可执行文件依然可以正常运行且行为不发生改变，此时可以说这个库是二进制兼容的，也就是ABI兼容。

**在ABI（二进制）的层面需要考虑到**：
- 函数符号（函数名，参数，返回值）
- 函数调用的约定（参数入参的顺序）
- 大小端，字节对齐
- 数据结构的的大小及内存布局等
- 头文件包含内联函数和宏（只能通过编译时进行体现，不会影响现存的二进制）
- C++虚函数，name mangling

当实现一个共享库时，应尽量维护好二进制兼容，尤其当用户很多，可以避免用户纷至沓来的抱怨，“老版本工作的好好地，新版本编译不过，或者编译过了但行为悄无声息的发生了变化（跟编译出错比起来这种是更令人厌恶的）”。

如何保持二进制的兼容？
- 通过明确的guideline进行规范
- pointer-to-implementation
- symbol versioning（glibc的做法）
- 其他的一些可以减轻但不能彻底根治的办法（视具体情况而定，比如结构体重预留字段，在末尾添加字段等）

注释：
- C与C++ ABI兼容相关问题，以后会详细讨论

### API的兼容性
也叫做源码级别的兼容，跟ABI兼容是运行时兼容比起来，这是一种编译时兼容，也就是当一个库有升级的版本时，需要重新编译一下程序（动态库或者可执行文件），不需要修改源代码。

这是比ABI更松散的一种兼容，现实场景可能遇到的更过（毕竟很多共享库都是项目内部维护的，实现的过程要求不是太高）。

**ABI，API兼容的关系？**
- ABI更为严苛，技术的约束度最高，而API的兼容性相对低很多
- ABI是二进制符号，内存层面，是运行时的约束，API是头文件函数签名是编译时的约束
- ？？是不是ABI兼容就一定是API兼容呢？？答案是否定的，比如保持二进制的符号不变，在头文件中移除一个函数声明

### 基于消息的协议兼容性
IPC通信经常会用到基于消息的，可参照protobuf的实现，或者直接使用。

### 系统兼容性
系统整体的对外表现，如界面设计，操作的流程，连接的外设(比如lan，wifi，蓝牙，输入输出设备等等)。